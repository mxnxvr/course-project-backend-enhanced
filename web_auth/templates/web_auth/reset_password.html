{% extends 'web_auth/base.html' %}

{% block title %}New Password{% endblock %}

{% block content %}
<h1>New Password</h1>
<p>Please enter your new password below.</p>

<form id="reset-password-form">
    <div class="input-group">
        <label for="password">New Password</label>
        <input type="password" id="password" name="password" required placeholder="••••••••">
    </div>
    <button type="submit" id="submit-btn">Reset Password</button>
</form>

<div id="status" class="status-message"></div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('reset-password-form');
    const status = document.getElementById('status');
    const btn = document.getElementById('submit-btn');
    const uid = "{{ uidb64 }}";
    const token = "{{ token }}";

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        btn.disabled = true;
        btn.textContent = "Resetting...";
        status.className = 'status-message';
        status.style.display = 'none';

        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`/api/reset-password/${uid}/${token}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ password })
            });

            const data = await response.json();

            if (response.ok) {
                status.textContent = "Password reset successfully! You can now log in.";
                status.classList.add('success');
                form.style.display = 'none';
            } else {
                status.textContent = data.error || "Invalid or expired token.";
                status.classList.add('error');
            }
        } catch (error) {
            status.textContent = "Network error. Please try again.";
            status.classList.add('error');
        } finally {
            if (status.classList.contains('error')) {
                btn.disabled = false;
                btn.textContent = "Reset Password";
            }
        }
    });
</script>
{% endblock %}